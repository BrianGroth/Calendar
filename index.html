<!DOCTYPE html>
<html lang="en">
<!-- Keep existing head section unchanged -->
<head>
  <!-- ... existing head content ... -->
</head>
<body>
  <div id="calendar"></div>

  <script>
    // Keep existing constants and helper functions unchanged until renderInitial()

    // Modify the renderInitial function to pre-load more months
    function renderInitial() {
      // Pre-render several months ahead
      for (let i = 0; i < 6; i++) { // Pre-load 6 months
        let monthToRender = currentMonth + i;
        let yearToRender = currentYear;
        
        while (monthToRender > 11) {
          monthToRender -= 12;
          yearToRender++;
        }
        
        if (yearToRender <= maxYear) {
          renderMonth(yearToRender, monthToRender, "end");
        }
      }

      // Also render one month in the past
      let prevMonth = currentMonth - 1;
      let prevYear = currentYear;
      if (prevMonth < 0) {
        prevMonth = 11;
        prevYear--;
      }
      if (prevYear >= minYear) {
        renderMonth(prevYear, prevMonth, "start");
      }
    }

    // Modify the scroll handler to be more proactive
    function handleScroll() {
      const scrollY = window.scrollY;
      const viewportHeight = window.innerHeight;
      const totalHeight = document.body.scrollHeight;

      // Load future months when user is approaching the top
      if (scrollY < viewportHeight) { // Increased threshold
        let nextMonth = currentMonth + 1;
        let nextYear = currentYear;
        if (nextMonth > 11) {
          nextMonth = 0;
          nextYear++;
        }

        if (nextYear < maxYear || (nextYear === maxYear && nextMonth <= maxMonth)) {
          currentMonth = nextMonth;
          currentYear = nextYear;
          requestAnimationFrame(() => {
            const oldHeight = document.body.scrollHeight;
            renderMonth(currentYear, currentMonth, "start");
            const heightDiff = document.body.scrollHeight - oldHeight;
            window.scrollBy(0, heightDiff); // Smoother scroll adjustment
          });
        }
      }

      // Load past months when approaching bottom
      if (scrollY + viewportHeight > totalHeight - viewportHeight) {
        let prevMonth = currentMonth - 1;
        let prevYear = currentYear;
        if (prevMonth < 0) {
          prevMonth = 11;
          prevYear--;
        }

        if (prevYear > minYear || (prevYear === minYear && prevMonth >= minMonth)) {
          currentMonth = prevMonth;
          currentYear = prevYear;
          renderMonth(currentYear, currentMonth, "end");
        }
      }
    }

    // Add throttling to prevent too frequent scroll handling
    function throttle(func, limit) {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      }
    }

    renderInitial();
    window.addEventListener("scroll", throttle(handleScroll, 150));
  </script>
</body>
</html>
