<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings • Shared Calendar</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topbar">
    <h1>Settings</h1>
    <nav>
      <a href="index.html"><button type="button">← Back to Calendar</button></a>
    </nav>
  </header>

  <main class="settings">
    <section class="card">
      <h2>GitHub Repository</h2>
      <p class="hint">PAT is used for committing settings and saving events. It's stored locally unless you put it in the repo (not recommended).</p>
      <div class="grid">
        <label>
          Owner (username)
          <input id="owner" type="text" placeholder="your-github-username" autocomplete="username" />
        </label>
        <label>
          Repository name
          <input id="repo" type="text" placeholder="Calendar" />
        </label>
        <label>
          GitHub Token (PAT)
          <input id="token" type="password" placeholder="ghp_..." autocomplete="off" />
        </label>
      </div>
    </section>

    <section class="card" style="margin-top:1rem;">
      <h2>Calendars & Integrations</h2>
      <div class="grid">
        <label>
          TripIt iCal URL
          <input id="tripit" type="url" placeholder="https://www.tripit.com/feed/ical/private/.../basic.ics" />
        </label>
        <div class="row">
          <label>
            US Holidays iCal URL
            <input id="hol_us" type="url" placeholder="https://...us-holidays.ics" />
          </label>
          <label>
            UK Holidays iCal URL
            <input id="hol_uk" type="url" placeholder="https://...uk-holidays.ics" />
          </label>
        </div>
        <label>
          NL Holidays iCal URL
          <input id="hol_nl" type="url" placeholder="https://...nl-holidays.ics" />
        </label>
      </div>
    </section>

    <section class="card" style="margin-top:1rem;">
      <h2>Preferences</h2>
      <div class="grid">
        <label>
          Theme
          <select id="theme">
            <option value="light">Light</option>
          </select>
        </label>
        <label>
          Week starts on
          <select id="weekStart">
            <option value="1">Monday</option>
          </select>
        </label>
        <label>
          Time format
          <select id="timeFormat">
            <option value="24">24-hour</option>
          </select>
        </label>
        <label>
          Timezone
          <select id="timezone">
            <option value="Europe/Amsterdam">Europe/Amsterdam</option>
          </select>
        </label>
      </div>
      <div class="actions">
        <button id="reloadSharedBtn" type="button">Reload Shared (read config/settings.json)</button>
        <button id="saveBtn" type="button">Save (Local)</button>
        <button id="saveSharedBtn" type="button">Save Shared (commit to repo)</button>
        <button id="clearBtn" type="button">Clear Local Settings</button>
      </div>
      <p class="hint">Local saves go to your browser. "Save Shared" writes <code>config/settings.json</code> in the repo. Make sure the path is exactly <code>config/settings.json</code> (all lowercase).</p>
    </section>
  </main>

  <div id="status" aria-live="polite" class="status"></div>

  <script src="lib/github.js"></script>
  <script>
    (function(){
      const KEY = 'calendar.settings.v1';
      const defaults = {
        owner: '', repo: 'Calendar', token: '',
        timeFormat24h: true, weekStart: 1, timezone: 'Europe/Amsterdam', theme:'light',
        tripitIcalUrl: '', holidays: { usUrl:'', ukUrl:'', nlUrl:'' }
      };

      function loadLocal(){ try{ const j=localStorage.getItem(KEY); return j? JSON.parse(j) : { ...defaults }; } catch{ return { ...defaults }; } }
      function saveLocal(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
      function status(msg){ const el=document.getElementById('status'); if(el) el.textContent=msg; }

      async function loadShared(){
        // If opened as file:// the fetch will be blocked — remind user
        if (location.protocol === 'file:') {
          status('Open this page via your GitHub Pages URL (https://.../settings.html), not file://');
        }
        try {
          const url = new URL('./config/settings.json', location.href);
// cache-bust to avoid old versions
url.searchParams.set('v', Date.now());

const res = await fetch(url.toString(), { cache: 'no-store' });

          if (!res.ok) { status('Could not read config/settings.json (HTTP '+res.status+').'); return null; }
          const json = await res.json();
          status('Loaded shared settings from config/settings.json');
          return json;
        } catch (e) {
          status('Failed to fetch config/settings.json. Check path/case and that it exists.');
          return null;
        }
      }

      function fillForm(from){
        if (!from) return;
        const $ = (id)=> document.getElementById(id);
        const { preferences = {}, holidays = {}, repo = {}, integrations = {} } = from;
        if (repo.owner) $('#owner').value = repo.owner;
        if (repo.name)  $('#repo').value  = repo.name;
        if (holidays.usUrl) $('#hol_us').value = holidays.usUrl;
        if (holidays.ukUrl) $('#hol_uk').value = holidays.ukUrl;
        if (holidays.nlUrl) $('#hol_nl').value = holidays.nlUrl;
        if (integrations.tripitIcalUrl) $('#tripit').value = integrations.tripitIcalUrl;
        if (preferences.theme) $('#theme').value = preferences.theme;
        if (typeof preferences.weekStart === 'number') $('#weekStart').value = String(preferences.weekStart);
        if (typeof preferences.timeFormat24h === 'boolean') $('#timeFormat').value = preferences.timeFormat24h ? '24' : '12';
        if (preferences.timezone) $('#timezone').value = preferences.timezone;
      }

      // --- Init form: load local first, then overlay shared ---
      const s = loadLocal();
      const $ = (id) => document.getElementById(id);
      $('#owner').value = s.owner || '';
      $('#repo').value = s.repo || 'Calendar';
      $('#token').value = s.token || '';
      $('#tripit').value = s.tripitIcalUrl || '';
      $('#hol_us').value = (s.holidays && s.holidays.usUrl) || '';
      $('#hol_uk').value = (s.holidays && s.holidays.ukUrl) || '';
      $('#hol_nl').value = (s.holidays && s.holidays.nlUrl) || '';
      $('#theme').value = s.theme || 'light';
      $('#weekStart').value = String(s.weekStart ?? 1);
      $('#timeFormat').value = s.timeFormat24h ? '24' : '12';
      $('#timezone').value = s.timezone || 'Europe/Amsterdam';

      // Now overlay shared file values if available
      loadShared().then(json => { if (json) fillForm(json); });

      // Local save
      $('#saveBtn').addEventListener('click', () => {
        const next = {
          owner: $('#owner').value.trim(),
          repo: $('#repo').value.trim() || 'Calendar',
          token: $('#token').value.trim(),
          timeFormat24h: $('#timeFormat').value === '24',
          weekStart: Number($('#weekStart').value || 1),
          timezone: $('#timezone').value,
          theme: $('#theme').value,
          tripitIcalUrl: $('#tripit').value.trim(),
          holidays: {
            usUrl: $('#hol_us').value.trim(),
            ukUrl: $('#hol_uk').value.trim(),
            nlUrl: $('#hol_nl').value.trim()
          }
        };
        saveLocal(next);
        status('Settings saved locally.');
      });

      // Clear local
      $('#clearBtn').addEventListener('click', () => {
        localStorage.removeItem(KEY);
        status('Local settings cleared. Page will now reload.');
        setTimeout(() => window.location.reload(), 600);
      });

      // Save Shared (commit config/settings.json)
      async function buildSharedJsonFromForm(){
        return {
          preferences: {
            theme: document.getElementById('theme').value,
            weekStart: Number(document.getElementById('weekStart').value || 1),
            timeFormat24h: document.getElementById('timeFormat').value === '24',
            timezone: document.getElementById('timezone').value
          },
          holidays: {
            usUrl: document.getElementById('hol_us').value.trim(),
            ukUrl: document.getElementById('hol_uk').value.trim(),
            nlUrl: document.getElementById('hol_nl').value.trim()
          },
          repo: {
            owner: document.getElementById('owner').value.trim(),
            name:  (document.getElementById('repo').value.trim() || 'Calendar')
          },
          integrations: {
            tripitIcalUrl: document.getElementById('tripit').value.trim()
          }
        };
      }

      async function saveShared(){
        const owner = (document.getElementById('owner').value || '').trim();
        const repo  = (document.getElementById('repo').value  || 'Calendar').trim();
        const token = (document.getElementById('token').value || '').trim();
        if (!owner || !repo || !token){ status('Owner, Repo and PAT are required to commit shared settings.'); return; }

        const path = 'config/settings.json';
        let sha = null;
        try { const got = await window.GitHubAPI.getFile(owner, repo, path, token); sha = got?.sha || null; } catch {}

        const content = JSON.stringify(await buildSharedJsonFromForm(), null, 2);
        try {
          await window.GitHubAPI.putFile(owner, repo, path, content, sha, token, 'chore(settings): update shared settings');
          status('Shared settings saved to repo at config/settings.json.');
        } catch (e) {
          status('Failed to save shared settings. Check token permissions.');
        }
      }

      document.getElementById('saveSharedBtn').addEventListener('click', saveShared);
      document.getElementById('reloadSharedBtn').addEventListener('click', async ()=>{ const j = await loadShared(); if (j) fillForm(j); });
    })();
  </script>
</body>
</html>
